---
import "@/styles/expressive-code.css";
import "@/styles/main.css";
import "@/styles/markdown-extend.css";
import "@/styles/markdown.css";
import "@/styles/photoswipe.css";
import "@/styles/scrollbar.css";
import "@/styles/transition.css";
import "@/styles/twikoo.css";
import "@/styles/variables.css";

import "misans/lib/Normal/MiSans-Medium.min.css"; // 380
import "misans/lib/Normal/MiSans-Bold.min.css"; // 630

import ConfigCarrier from "@components/ConfigCarrier.astro";
import ImageManager from "@components/misc/ImageManager.svelte";
import { profileConfig, siteConfig } from "@/config";
import {
	AUTO_MODE,
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import type { Favicon } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";
import "katex/dist/katex.css";

interface Props {
	title?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
	postSlug?: string;
}

let { title, description, lang, setOGTypeArticle, postSlug } = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = `${siteConfig.title} - ${siteConfig.subtitle}`;
}

let ogImageUrl: string | undefined;
if (siteConfig.generateOgImages && postSlug) {
	ogImageUrl = new URL(`/og/${postSlug}.png`, Astro.site).toString();
} else if (siteConfig.banner.enable && siteConfig.banner.src) {
	ogImageUrl = new URL(url(siteConfig.banner.src), Astro.site).toString();
}

const favicons: Favicon[] = siteConfig.favicon;

const siteLang = (lang || siteConfig.lang).replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.banner.position || "center"];
---

<!doctype html>
<html
	lang={siteLang}
	class="bg-(--page-bg) transition text-[14px] md:text-[16px]"
	data-overlayscrollbars-initialize
>
	<head>
		<!-- Cloudflare Web Analytics -->
		<script
			is:inline
			async
			src="https://cwa.xeonzilla.top/fuwari-debug.js"
			data-cf-beacon='{"send":{"to": "https://cwa.xeonzilla.top/fuwari-debug"},"token": "b9c63268ef0347f2a3f9dd68ad60b8cc"}'
		></script>

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="description" content={description || pageTitle} />
		<meta name="author" content={profileConfig.name} />

		<meta property="og:site_name" content={siteConfig.title} />
		<meta property="og:url" content={Astro.url} />
		<meta property="og:title" content={pageTitle} />
		<meta property="og:description" content={description || pageTitle} />
		{ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
		{
			setOGTypeArticle ? (
				<meta property="og:type" content="article" />
			) : (
				<meta property="og:type" content="website" />
			)
		}

		<meta name="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content={Astro.url} />
		<meta name="twitter:title" content={pageTitle} />
		<meta name="twitter:description" content={description || pageTitle} />

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		{
			favicons.map((favicon) => (
				<link
					rel="icon"
					href={
						favicon.src.startsWith("/")
							? url(favicon.src)
							: favicon.src
					}
					sizes={favicon.sizes}
					media={
						favicon.theme &&
						`(prefers-color-scheme: ${favicon.theme})`
					}
				/>
			))
		}

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script
			is:inline
			define:vars={{
				DEFAULT_THEME,
				LIGHT_MODE,
				DARK_MODE,
				AUTO_MODE,
				BANNER_HEIGHT_EXTEND,
				PAGE_WIDTH,
				configHue,
			}}
		>
			// Load the theme from local storage
			const theme = localStorage.getItem("theme") || DEFAULT_THEME;
			switch (theme) {
				case LIGHT_MODE:
					document.documentElement.classList.remove("dark");
					break;
				case DARK_MODE:
					document.documentElement.classList.add("dark");
					break;
				case AUTO_MODE:
					if (
						window.matchMedia("(prefers-color-scheme: dark)")
							.matches
					) {
						document.documentElement.classList.add("dark");
					} else {
						document.documentElement.classList.remove("dark");
					}
			}

			// Load the hue from local storage
			const hue = localStorage.getItem("hue") || configHue;
			document.documentElement.style.setProperty("--hue", hue);

			// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			let offset = Math.floor(
				window.innerHeight * (BANNER_HEIGHT_EXTEND / 100),
			);
			offset = offset - (offset % 4);
			document.documentElement.style.setProperty(
				"--banner-height-extend",
				`${offset}px`,
			);
		</script>
		<style
			define:vars={{
				configHue,
				"page-width": `${PAGE_WIDTH}rem`,
			}}
		></style>
		<!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->

		<slot name="head" />

		<link
			rel="alternate"
			type="application/rss+xml"
			title={profileConfig.name}
			href={`${Astro.site}rss.xml`}
		/>
		<link
			rel="alternate"
			type="application/atom+xml"
			title={profileConfig.name}
			href={`${Astro.site}atom.xml`}
		/>
	</head>
	<body
		class="min-h-screen transition"
		class:list={[{ "is-home": isHomePage, "enable-banner": enableBanner }]}
		data-overlayscrollbars-initialize
	>
		<ConfigCarrier />
		<slot />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>
		<ImageManager client:idle />
	</body>
</html>

<style
	is:global
	define:vars={{
		bannerOffset,
		"banner-height-home": `${BANNER_HEIGHT_HOME}vh`,
		"banner-height": `${BANNER_HEIGHT}vh`,
	}}
>
	@reference "../styles/main.css";
	@layer components {
		.enable-banner.is-home #banner-wrapper {
			@apply lg:translate-y-(--banner-height-extend);
		}
		.enable-banner #banner-wrapper {
			@apply h-(--banner-height-home);
		}
		.enable-banner.is-home #banner {
			@apply lg:translate-y-0;
		}
		.enable-banner #banner {
			@apply h-(--banner-height-home) translate-y-(--bannerOffset);
		}
		.enable-banner.is-home #main-grid {
			@apply lg:translate-y-(--banner-height-extend);
		}
		.enable-banner #top-row {
			@apply h-[calc(var(--banner-height-home)-4.5rem)] transition-all duration-300;
		}
		.enable-banner.is-home #sidebar-sticky {
			@apply lg:top-[calc(1rem-var(--banner-height-extend))]!;
		}
		.navbar-hidden {
			@apply opacity-0 -translate-y-16;
		}
	}
</style>

<script>
	import "overlayscrollbars/overlayscrollbars.css";
	import {
		OverlayScrollbars,
		// ScrollbarsHidingPlugin,
		// SizeObserverPlugin,
		// ClickScrollPlugin
	} from "overlayscrollbars";
	import { pathsEqual, url } from "../utils/url-utils";
	import {
		BANNER_HEIGHT,
		BANNER_HEIGHT_HOME,
		BANNER_HEIGHT_EXTEND,
		MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
	} from "../constants/constants";
	import { siteConfig } from "../config";

	// Banner utility functions
	const bannerEnabled = siteConfig.banner.enable;
	const NAVBAR_HEIGHT = 72;

	// Calculate --banner-height-extend, must be a multiple of 4 to avoid blurry text
	function calculateBannerHeightExtend() {
		let offset = Math.floor(
			window.innerHeight * (BANNER_HEIGHT_EXTEND / 100),
		);
		offset = offset - (offset % 4);
		document.documentElement.style.setProperty(
			"--banner-height-extend",
			`${offset}px`,
		);
	}

	function getScrollTop(): number {
		return document.documentElement.scrollTop || document.body.scrollTop;
	}

	function isHomePage(): boolean {
		return document.body.classList.contains("is-home");
	}

	function getCurrentBannerHeight(): number {
		const isHome = isHomePage();
		const isLargeScreen = window.innerWidth >= 1024;
		const heightVh =
			isHome && isLargeScreen ? BANNER_HEIGHT_HOME : BANNER_HEIGHT;
		return window.innerHeight * (heightVh / 100);
	}

	function calculateNavbarThreshold(): number {
		const bannerHeight = getCurrentBannerHeight();
		const mainPanelExcessHeight = MAIN_PANEL_OVERLAPS_BANNER_HEIGHT * 16;
		return bannerHeight - NAVBAR_HEIGHT - mainPanelExcessHeight - 16;
	}

	function initCustomScrollbar() {
		const bodyElement = document.querySelector("body");
		if (!bodyElement) return;
		OverlayScrollbars(
			// docs say that a initialization to the body element would affect native functionality like window.scrollTo
			// but just leave it here for now
			{
				target: bodyElement,
				cancel: {
					nativeScrollbarsOverlaid: true, // don't initialize the overlay scrollbar if there is a native one
				},
			},
			{
				scrollbars: {
					theme: "scrollbar-base scrollbar-auto py-1",
					autoHide: "move",
					autoHideDelay: 500,
					autoHideSuspend: false,
				},
			},
		);

		const katexElements = document.querySelectorAll(
			".katex-display",
		) as NodeListOf<HTMLElement>;

		const katexObserverOptions = {
			root: null,
			rootMargin: "100px",
			threshold: 0.1,
		};

		const processKatexElement = (element: HTMLElement) => {
			if (!element.parentNode) return;
			if (element.hasAttribute("data-scrollbar-initialized")) return;

			const container = document.createElement("div");
			container.className = "katex-display-container";
			container.setAttribute(
				"aria-label",
				"scrollable container for formulas",
			);

			element.parentNode.insertBefore(container, element);
			container.appendChild(element);

			OverlayScrollbars(container, {
				scrollbars: {
					theme: "scrollbar-base scrollbar-auto",
					autoHide: "leave",
					autoHideDelay: 500,
					autoHideSuspend: false,
				},
			});

			element.setAttribute("data-scrollbar-initialized", "true");
		};

		const katexObserver = new IntersectionObserver((entries, observer) => {
			entries.forEach((entry) => {
				if (entry.isIntersecting) {
					processKatexElement(entry.target as HTMLElement);
					observer.unobserve(entry.target);
				}
			});
		}, katexObserverOptions);

		katexElements.forEach((element) => {
			katexObserver.observe(element);
		});
	}

	function showBanner() {
		if (!bannerEnabled) return;

		const banner = document.getElementById("banner");
		if (!banner) {
			console.error("Banner element not found");
			return;
		}

		banner.classList.remove("opacity-0", "scale-105");
	}

	function initCommentComponent() {
		document.dispatchEvent(new Event("loadComment"));
	}

	function init() {
		calculateBannerHeightExtend();
		initCustomScrollbar();
		showBanner();
		initCommentComponent();
	}

	/* Load settings when entering the site */
	init();

	const setup = () => {
		window.swup.hooks.on("link:click", () => {
			// Remove the delay for the first time page load
			document.documentElement.style.setProperty(
				"--content-delay",
				"0ms",
			);

			// prevent elements from overlapping the navbar
			if (!bannerEnabled) {
				return;
			}

			const navbar = document.getElementById("navbar-wrapper");
			if (!navbar || !isHomePage()) {
				return;
			}

			const threshold = calculateNavbarThreshold();
			if (getScrollTop() >= threshold) {
				navbar.classList.add("navbar-hidden");
			}
		});
		window.swup.hooks.on("content:replace", () => {
			initCustomScrollbar();
			initCommentComponent();
		});
		window.swup.hooks.on(
			"visit:start",
			(visit: { to: { url: string } }) => {
				// change banner height immediately when a link is clicked
				const bodyElement = document.querySelector("body");
				if (pathsEqual(visit.to.url, url("/"))) {
					bodyElement!.classList.add("is-home");
				} else {
					bodyElement!.classList.remove("is-home");
				}

				// increase the page height during page transition to prevent the scrolling animation from jumping
				const heightExtend =
					document.getElementById("page-height-extend");
				if (heightExtend) {
					heightExtend.classList.remove("hidden");
				}

				// Hide the TOC while scrolling back to top
				let toc = document.getElementById("toc-wrapper");
				if (toc) {
					toc.classList.add("toc-not-ready");
				}
			},
		);
		window.swup.hooks.on("page:view", () => {
			// hide the temp high element when the transition is done
			const heightExtend = document.getElementById("page-height-extend");
			if (heightExtend) {
				heightExtend.classList.remove("hidden");
			}
		});
		window.swup.hooks.on("visit:end", (_visit: { to: { url: string } }) => {
			setTimeout(() => {
				const heightExtend =
					document.getElementById("page-height-extend");
				if (heightExtend) {
					heightExtend.classList.add("hidden");
				}

				// Just make the transition looks better
				const toc = document.getElementById("toc-wrapper");
				if (toc) {
					toc.classList.remove("toc-not-ready");
				}
			}, 200);
		});
	};
	if (window?.swup?.hooks) {
		setup();
	} else {
		document.addEventListener("swup:enable", setup);
	}

	const backToTopBtn = document.getElementById("back-to-top-btn");
	const toc = document.getElementById("toc-wrapper");
	const navbar = document.getElementById("navbar-wrapper");

	function scrollFunction() {
		const scrollTop = getScrollTop();
		const bannerHeight = getCurrentBannerHeight();

		// Control back to top button visibility
		if (backToTopBtn) {
			if (scrollTop > bannerHeight) {
				backToTopBtn.classList.remove("hide");
			} else {
				backToTopBtn.classList.add("hide");
			}
		}

		// Control TOC visibility
		if (bannerEnabled && toc) {
			if (scrollTop > bannerHeight) {
				toc.classList.remove("toc-hide");
			} else {
				toc.classList.add("toc-hide");
			}
		}

		// Control navbar visibility
		if (bannerEnabled && navbar) {
			const threshold = calculateNavbarThreshold();
			if (scrollTop >= threshold) {
				navbar.classList.add("navbar-hidden");
			} else {
				navbar.classList.remove("navbar-hidden");
			}
		}
	}

	window.onscroll = scrollFunction;
	window.onresize = calculateBannerHeightExtend;
</script>
