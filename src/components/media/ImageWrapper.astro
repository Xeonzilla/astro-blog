---
import { Image } from "astro:assets";
import { url } from "@utils/url-utils";

interface Props {
    id?: string;
    src: string;
    class?: string;
    alt?: string;
    position?: string;
    basePath?: string;
    priority?: boolean;
    widths?: number[];
    sizes?: string;
    quality?: number;
}

const {
    id,
    src,
    alt = "",
    position = "center",
    basePath = "",
    priority,
    widths,
    sizes,
    quality,
} = Astro.props;
const className = Astro.props.class;

const isPublic = src.startsWith("/");
const isRemote =
    src.startsWith("http") ||
    src.startsWith("https") ||
    src.startsWith("data:");
const isLocal = !(isPublic || isRemote);

// Detect AVIF
const isAvif = /\.avif$/i.test(src);

// TODO temporary workaround for images dynamic import
// https://github.com/withastro/astro/issues/3373
// biome-ignore lint/suspicious/noImplicitAnyLet: <check later>
let img;
if (isLocal) {
    const files = import.meta.glob<ImageMetadata>(
        ["../../assets/**", "../../content/**"],
        {
            import: "default",
        },
    );
    const normalizedPath = `../../${basePath}${src}`
        .replace(/\\/g, "/")
        .replace(/\/\.\//g, "/")
        .replace(/\/+/g, "/");
    const file = files[normalizedPath];
    if (!file) {
        console.error(
            `\n[ERROR] Image file not found: ${normalizedPath.replace("../../", "src/")}`,
        );
    } else {
        img = await file();
    }
}

const imageClass = "object-cover h-full w-full opacity-0 image-content";
const imageStyle = `object-position: ${position}`;
const imageProps = {
    alt,
    priority,
    widths,
    sizes,
    quality,
    class: imageClass,
    style: imageStyle,
    "data-image-element": true,
};
---

<div
    id={id}
    class:list={[className, "overflow-hidden relative"]}
    data-image-wrapper
>
    <div
        class="loading-bar absolute top-1/2 left-1/2 -translate-1/2 w-[min(8rem,75%)] h-1 bg-[oklch(0.9_0.05_var(--hue)/0.5)] dark:bg-[oklch(0.4_0.08_var(--hue)/0.25)] z-10 rounded-full overflow-hidden transition-opacity duration-500 ease-out"
    >
        <div
            class="loading-bar-track left-[-145.167%] animate-[2s_primary-indeterminate-translate_infinite_linear]"
        >
            <div
                class="bar-inner animate-[2s_primary-indeterminate-scale_infinite_linear]"
            >
            </div>
        </div>
        <div
            class="loading-bar-track left-[-54.8889%] animate-[2s_secondary-indeterminate-translate_infinite_linear]"
        >
            <div
                class="bar-inner animate-[2s_secondary-indeterminate-scale_infinite_linear]"
            >
            </div>
        </div>
    </div>
    {
        isPublic && (
            <img
                src={url(src)}
                alt={alt}
                sizes={sizes}
                class={imageClass}
                style={imageStyle}
                data-image-element
            />
        )
    }
    {
        isRemote && (
            <Image
                src={src}
                inferSize={true}
                {...imageProps}
                {...(isAvif && { format: "avif" })}
            />
        )
    }
    {
        isLocal && img && (
            <Image
                src={img}
                {...imageProps}
                {...(isAvif && { format: "avif" })}
            />
        )
    }
</div>

<style>
    .loading-bar {
        direction: ltr;
        contain: layout paint;
    }

    .image-content {
        transition:
            opacity 0.5s ease-out,
            transform 0.3s ease-out;
    }

    .image-content.loaded {
        opacity: 1;
    }
</style>
